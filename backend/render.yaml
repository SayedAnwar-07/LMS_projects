services:
  - type: web
    name: django-backend
    env: python
    startCommand: gunicorn backend.wsgi:application
    envVars:
      - key: SECRET_KEY
        value: django-insecure-%8w9=v^+e5y5u$%1s@kcd6y!zf8%@54^_5omevb
      - key: DEBUG
        value: False
      - key: ALLOWED_HOSTS
        value: django-backend.onrender.com
      - key: STRIPE_SECRET_KEY
        value: sk_test_51RbwOQDCq52O5K5ofUDnOjx8vC8z0m0Pt56p0su2qU9eXbrQxr3WoF1LeiAY7TuAtyS9Wjfwx73OMYTdZPFks4bj00MHaO2oIs
      - key: PUBLISHABLE_KEY
        value: pk_test_51RbwOQDCq52O5K5oOP8pYDX4KLNbsvlu3kYXlL8O8TiJP18uXBF5mvxP2eJXiSnYvFL5Uc55sJpkq0mgyLmUQPiU00r4hGQmGs
      - key: EMAIL_HOST
        value: smtp.gmail.com
      - key: EMAIL_PORT
        value: 587
      - key: EMAIL_USE_TLS
        value: True
      - key: EMAIL_HOST_USER
        value: dextervilgax@gmail.com
      - key: EMAIL_HOST_PASSWORD
        value: rsjtilonubmqjkpm
      - key: DEFAULT_FROM_EMAIL
        value: dextervilgax@gmail.com
      - key: SITE_NAME
        value: The Learning Hall
      - key: DB_ENGINE
        value: django.db.backends.sqlite3
      - key: DB_NAME
        value: db.sqlite3

    buildCommand: |
      pip install -r requirements.txt
      python manage.py collectstatic --noinput

    preDeployCommand: |
      # 1) apply all migrations
      python manage.py migrate --noinput

      # 2) idempotent superuser creation
      python - <<'EOF'
      from django.contrib.auth import get_user_model
      User = get_user_model()
      if not User.objects.filter(username='admin').exists():
        User.objects.create_superuser(
            username='admin',
            email='admin@example.com',
            password='StrongPass123'
        )
        print("🛡️ Superuser ‘admin’ created")
      else:
          print("🛡️ Superuser ‘admin’ already exists")
      EOF

    startCommand: |
      gunicorn backend.wsgi:application --bind 0.0.0.0:$PORT
